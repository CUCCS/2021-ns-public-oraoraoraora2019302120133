# Web 应用漏洞攻防

### 实验目的

了解常见 Web 漏洞训练平台；
了解 常见 Web 漏洞的基本原理；
掌握 OWASP Top 10 及常见 Web 高危漏洞的漏洞检测、漏洞利用和漏洞修复方法；

### 实验环境

WebGoat7.1/8.0
kali

### 实验要求

 每个实验环境完成不少于 5 种不同漏洞类型的漏洞利用练习；
 （可选）使用不同于官方教程中的漏洞利用方法完成目标漏洞利用练习;
 （可选）最大化 漏洞利用效果实验；
 （可选）编写 自动化 漏洞利用脚本完成指定的训练项目；（使用工具:burpsuite）
 （可选）定位缺陷代码；
 （可选）尝试从源代码层面修复漏洞；

webgoat环境下漏洞类型练习

## WebGoat 训练平台与其他常见漏洞训练平台横向对比

| 漏洞类型                  | [WebGoat 8.0](https://hub.docker.com/r/webgoat/webgoat-8.0/)/7.1 |
| ------------------------- | ------------------------------------------------------------ |
| 未验证的用户输入          | ✓                                                            |
| CSRF                      |                                                              |
| 缓冲区溢出                |                                                              |
| 文件上传漏洞              |                                                              |
| 文件包含                  |                                                              |
| XXE                       |                                                              |
| 反序列化                  |                                                              |
| 第三方组件缺陷            |                                                              |
| SQL 注入                  | ✓                                                            |
| 命令注入                  |                                                              |
| SSRF                      |                                                              |
| XSS                       | ✓                                                            |
| 信息泄漏                  |                                                              |
| Web 服务器 URI 解析类漏洞 |                                                              |
| 不当配置缺陷              |                                                              |
| 脆弱的访问控制            | ✓                                                            |

### 实验环境搭建

###### 一.环境搭建

1.安装dcoker-compose

```kali
apt update && apt install docker-compose
```

![](.\img\1.png)

2.查看镜像

```
 apt policy docker.io 
```

![](.\img\2.png)

3.继续搭建

```
# 一次获取所有文件（包括所有子模块管理的文件）
git clone https://github.com/c4pr1c3/ctf-games.git --recursive

cd ctf-games

# （可选）单独更新子模块
git submodule init && git submodule update

# 启动 webgoat 系列服务
cd owasp/webgoat/ && docker-compose up -d

# 启动 juice-shop 及 shake-logger 服务
cd ../../owasp/juice-shop/ && docker-compose up -d
```

<img src=".\img\3.png" style="zoom:80%;" />

<img src=".\img\4.png" style="zoom:67%;" />

<img src=".\img\5.png" style="zoom:67%;" />

4.安装dvwa

```
docker pull infoslack/dvwa
docker run -d -p 8086:80 infoslack/dvwa
```

<img src=".\img\6.png" style="zoom:67%;" />

![](.\img\7.png)

使用`docker ps`查看平台地址端口信息：

Webgoat：

![](.\img\8.png)

juice-shop：

![](.\img\9.png)

我们可以通过登录Webgoat页面`127.0.0.1:8087/WebGoat/attack`来验证我们的7.1版本是否安装成功，以及8080端口访问验证8.0是否安装成功，我们通过guest登录上以后可以看到所有漏洞攻击类型

<img src=".\img\91.png" style="zoom: 33%;" />

### 实验过程

#### 未验证的用户输入

- 先登录到webgoat7.1/8.0版本界面，进行绕过前端检查实验，其实也是在感受前端检查的虚无，原理：未进行验证的用户通过修改前端代码实现前端验证的绕过`Parameter Tampering ( 1. 未验证的用户输⼊ )-->Bypass HTML Field Restrictions`

- 先查看该实验要求，即绕过前端的检查，使得可以输入‘不合法’的字段

  ![](.\img\92.png)

- 打开开发者工具，查看界面代码，并观察哪里有与检查相关的信息，利用firefox的`inspector`工具可以很先查看该实验要求，即绕过前端的检查，使得可以输入‘不合法’的字段

  ![](.\img\93.png)

  先查看该实验要求，即绕过前端的检查，使得可以输入‘不合法’的字段

  <img src=".\img\94.png" style="zoom: 80%;" />

  

  通过开发工具，可以很容易的绕过前端的限制

  <img src=".\img\96.png" style="zoom: 80%;" />

- webgoat8.0版本修改，这属于直接用开发者工具实验

  <img src=".\img\95.png" style="zoom: 80%;" />

- 接下来使用`burpsuite`代理工具进行实验，在工具里面可以进行拦截和重发之类的操作

  <img src=".\img\97.png" style="zoom: 80%;" />

- 进行修改并转发包，只需要将上述字段有所修改即可，本次实验随意修改上述字段。使用burpsuite进行修改字段并重放，最终实现绕过前端限制攻击，原因还是未验证的用户容易实现非法输入

  #### 脆弱的访问控制

  - 准备实验环境：webgoat7.1，登录，打开 Authentication Flows --> Forgot Password

    <img src=".\img\98.png" style="zoom: 80%;" />

  - 实验原理：内容或程序功能未能有效的保护以限制只允许合法用户的访问，使得攻击者得以利用并进行攻击，这通常是攻击者进行攻击的基本条件

  - 实验目的是达到获取其他用户的密码，首先进行自己信息的输入，获取到了results

    [<img src=".\img\99.png" style="zoom: 80%;" />

  - 这次实验通过忘记密码机制可直接猜出用户喜欢的颜色，或可以通过自动化方式实现穷举攻击，`非常可怕的是`，我只是看了参考中的实验报告，就试出webgoat喜欢的颜色是red，即获取了webgoat的密码，原因是该网站的认证非常脆弱，没有任何锁定机制，非常容易就暴力破解了

  #### XSS攻击

  - 准备实验环境：webgoat7.1，登录，打开xss-->phishing with xss，另外，我们可以查看界面任意元素的层级结构，原理：由于网站没有对输入内容的合法性的检测，导致用户可以输入一段可被执行的脚本或其他可执行代码

  - phishing with xss原理是：通过xss攻击获取受害者的cookie，cookie变成发送的参数发送到服务器中，这次实验的目的是获取cookie

    <img src=".\img\911.png" style="zoom: 80%;" />

  - 本次实验输入代码，即弹出一个弹窗

    ```
    <script language="javascript" type="text/javascript">alert('hack')</script>
    ```

    <img src=".\img\912.png" style="zoom: 80%;" />

  - 打开实验要求网址：`http://127.0.0.1:8087/WebGoat/catcher?PROPERTY=yes`，向其发送凭证，即实验成功，相当于我们获取了之前输入的内容（脚本）

    <img src=".\img\913.png" style="zoom: 80%;" />

  #### sql注入攻击

  - 准备实验环境：webgoat7.1，登录，打开injection flaws-->log spoofing

  - 原理： 就是通过把SQL命令插入到Web表单递交或输入域名或页面请求的查询字符串，最终达到欺骗服务器执行恶意的SQL命令，其实和XSS攻击有异曲同工之处

    <img src=".\img\915.png" style="zoom: 80%;" />

  - 我们在该网站中输入了如下sql代码

    ```
    %' and '0'='0 
    ```

  - 由于登录模块使用了如下的SQL查询语句，我们用来%表示所有值，这样可以获取表中的所有信息，这是由于输入的语句中包含了一个恒为真的等式，sql语句会一直执行，从而实现了sql注入攻击

    ```
     "select * from users where user='"\+ username + "'and password='"\+ hashedPassword + "'"
    ```

  - 最终成功实现了sql攻击

    <img src=".\img\916.png" style="zoom: 80%;" />

  #### 脆弱认证和会话管理

  - 准备实验环境：webgoat7.1，登录，打开 Session Management Flows --> Session Fixation

  - 原理：由于未采用Session cookie，⽽是在URL中编码已通过认证的用户名和密码，可能会导致攻击者可以破坏密码，密钥，会话令牌或实施漏洞冒充其他用户身份， 服务器通过每个用户的唯一的Session ID 来确认其合法性。如果用户已登录，并且授权他不必重新验证授权时，当他重新登录应用系统时，他的Session ID 依然是被认为合法的。在一些程序中，可能会在GET-REQUEST 请求中传递Session ID。这就是攻击的起点。

  - 本次实验要求输入SID，使得获取到受害者的session，即受害者一旦点击攻击者输入的cookie，并更新界面，获取受害者的session

    <img src=".\img\917.png" style="zoom: 80%;" />

  - 将sid输入到邮件链接中后第一阶段完成

  - ```
    SID=90B5D2D2FAFCF2A3D9C3F0E00BB137E9
    ```

    <img src=".\img\918.png" style="zoom: 80%;" />

  - 查看邮件，发现发送的邮件（受害者将收到的邮件）中包含一个链接，我们知道其中包含我们刚刚输入的SID

  - 登录受害者邮箱查收邮件，受害者点击链接，并输入用户信息，而cookie不变，但是界面内容已经变为受害者的信息界面了

  - 攻击者准备获取session

  - ![](.\img\919.png)

  - 攻击者只需要在链接里将SID改为开始输进去的SID，即可获得受害者的信息界面

    ![](.\img\920.png)

![](.\img\921.png)

### 实验问题

1.搭建不了dvwa环境

![](.\img\fault\1.png)

![](.\img\fault\2.png)

在输入代码即可

```
sudo chmod a+rw /var/run/docker.sock
```

![](.\img\fault\3.png)

2.打不开webgoat

全部重装

<img src=".\img\fault\4.png" style="zoom:80%;" />

### 实验参考

[1](https://blog.csdn.net/lemonalla/article/details/105592268)

[2](https://blog.csdn.net/u011337602/article/details/104541261)

[3](https://github.com/CUCCS/2021-ns-public-cuczbj/blob/chap7/Web%20%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E%E6%94%BB%E9%98%B2/Web%20%E5%BA%94%E7%94%A8%E6%BC%8F%E6%B4%9E%E6%94%BB%E9%98%B2.md)